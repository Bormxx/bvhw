## Развёртывание проекта Taski в кластер Yandex.Cloud с помощью Kubernetes.
### Введение
Чтобы всё это заработало, вам необходимо иметь кластер в Yandex.Cloud.
Инструкция по его созданию находится в этом же репозитории, в папке k8s-terraform.
Данное руководство создано для установки уже созданного проекта [Taski](https://github.com/yandex-praktikum/taski).
Здесь не будет описан сам проект **Taski**, для чего он нужен, на каком языке написан, какие технологии использует и т.д. 
Этот репозиторий создан с целью демонстрации автоматического разворачивания проекта **Taski** в облачном кластере.
#### Внимание! В данной работе намеренно не автоматизируется процесс создания и загрузки в облако образов docker-контейнеров. Это связано с тем, что у пользователей могут быть разные операционные системы, по этой причине программы для автоматизации отличаются.

Проект состоит из двух частей:
- frontend
- backend

Каждая часть будет помещена в свой docker-контейнер.

В процессе автоматического развёртывания к ним будет добавлен ещё один контейнер, для связки друг с другом.

Все docker-контейнеры собираются в версии alpine, что делает их легковесными. 
Ниже будут приведены показатели размеров получившихся контейнеров.

### Этапы развёртывания.

Развёртывание проекта происходит в два этапа:
- Подготовка.
  На этом этапе вы проверяете, что необходимые программы установлены, выполняете привязку Yandex.Cloud к Kubectl, создаёте реестр для хранения образов docker-контейнеров, создание и загрузка образов docker-контейнеров в облако Yandex.Cloud.
  
- Развёртывание проекта.
  На этом этапе вы разворачиваете проект Taski на кластере Yandex.Cloud, с помощью Kubectl.
  
### Подготовка.
#### Необходимое программное обеспечение для развёртывание проекта Taski в облаке Yandex.Cloud.
Для того, чтобы выполнять действия по созданию кластера вам понадобятся следующие программы:
- Операционная система **Linux** или **MacOs**. Если у вас операционная система **Windows 10** версии 2004 и выше, или более новая Windows, то необходимо [установить WSL](https://learn.microsoft.com/ru-ru/windows/wsl/install)  - это поддержка Linux на Windows.
- Программа **YC** для работы с интерфейсом командной строки CLI (command line interface). Если вы в будущем будете читать документацию по Yandex.Cloud, то примеры с реализацией в CLI будут встречаться довольно часто. Если этой программы ещё нет у вас, то [установите](https://yandex.cloud/ru/docs/cli/operations/install-cli#linux_1) её.
- Программа **Kubectl**. Это программа, которая обрабатывает файлы с инструкциями (манифесты), написанными в формате YAML (YAML Ain't Markup Language). С помощью **Kubectl** мы будем подключаться к нашему кластеру в облаке Яндекс и получать информацию о нём. Если у вас ещё нет этой программы, то [установите](https://kubernetes.io/ru/docs/tasks/tools/install-kubectl/) её.
- Программа **Docker**. Это программа, которая обрабатывает файлы с инструкциями (манифесты), написанными в формате YAML (YAML Ain't Markup Language). С помощью **Docker** мы будем создавать и загружать образы docker-контейнеров в облако Yandex.Cloud. Если у вас ещё нет этой программы, то [установите](https://docs.docker.com/engine/install/) её.

#### Настройка переменных.
На этом этапе у вас должна быть зарегистрированная и активная учётная запись в Yandex.Cloud.
Если у вас есть учётная запись в облаке Яндекс, то вам доступен каталог, созданный по умолчанию. У этого каталога есть идентификационный номер **ID**, который мы сейчас с вами получим и будем использовать в дальнейшем.
1. Создайте текстовый файл, в который вы запишете необходимые данные.

2. Привяжите кластер Yandex.Cloud к программе kubectl.
Для того, чтобы узнать ID кластера в Yandex.Cloud выполните команду:
```
yc managed-kubernetes cluster list
```
Запишите ID и NAME кластера в свой текстовый файл.

Чтобы привязать кластер к программе kubectl выполните команду:
```
yc managed-kubernetes cluster get-credentials <имя вашего кластера, который вы записали> --external --force
```

Проверьте привязку с помощью команды:
```
kubectl cluster-info
```

3. Создайте реестр хранения образов docker-контейнеров. Вы должны придумать какое-нибудь имя, например taski-registry.
Для создания реестра хранения выполните команду:
```
yc container registry create --name <имя вашего реестра>
```
Вы получите такой вывод. 
<p align="center"><img src="./images/registry.png" alt="Создание реестра хранения образов docker-контейнеров."></p>

Скопируйте и запишите в свой текстовый файл id реестра.

Или, внесите id в переменную окружения. Если у вас Линукс, то команда такая:
```
echo "export REGISTRY_ID=<ваш id реестра>" >> ~/.bashrc . ~/.bashrc
```
Если Windows, то в PowerShell выполните:
```
$Env:REGISTRY_ID=<ваш id реестра>
```
Закройте интерфейс командной строки и откройте снова. Выполните команду:
```
yc container registry get $REGISTRY_ID
```
Вы должны получить данные о реестре. Если они не получаются, то пользуйтесь текстовым файлом, который вы создали.

4. Создайте образы docker-контейнеров и загрузите их в облако Yandex.Cloud.
Скопируйте из репозитория содержимое. Папку images можно не копировать.

Откройте интерфейс командной строки в папке frontend.
Выполните поочерёдно следующие команды, по необходимости заменив $REGISTRY_ID на ваш id реестра, который вы записали в пункте 3 этой инструкции:
```
docker build . --tag cr.yandex/$REGISTRY_ID/taski-frontend:v1
docker push cr.yandex/$REGISTRY_ID/taski-frontend:v1
```

Перейдите в папку backend и выполните поочерёдно следующие команды:
```
docker build . --tag cr.yandex/$REGISTRY_ID/taski-backend:v1
docker push cr.yandex/$REGISTRY_ID/taski-backend:v1
```

Перейдите в папку nginx и выполните поочерёдно следующие команды:
```
docker build . --tag cr.yandex/$REGISTRY_ID/taski-forw:v1
docker push cr.yandex/$REGISTRY_ID/taski-forw:v1
```

Проверьте список загруженных в облако Yandex.Cloud образов docker-контейнеров с помощью команды:
```
yc container image list
```
У вас должна получиться таблица с тремя образами контейнеров.

Откройте файл k8s.yaml и отредактируйте его, заменив $REGISTRY_ID на ваш id реестра, который вы записали в ваш текстовый файл. 
> *Замену $REGISTRY_ID на ваш id реестра можно автоматизировать, но я не знаю, как это сделать в Windows и MacOs, поэтому, оставляю эту часть для ручного редактирования.*

На этом подготовка завершена. Можно переходить к развёртыванию контейнеров в кластере.

### Развёртывание контейнеров в облачном кластере с помощью Kubectl.
Откройте интерфейс командной строки в папке, содержащей файлы *k8s.yaml, load-balancer.yaml* и т.д.
Выполните команду:
```
kubectl apply -f k8s.yaml
```
Проверьте состояние кластера, выполнив команду:
```
kubectl get pods
```

Если статус ваших pods будет *"ContainerCreating"*, то подождите немного и снова выполните эту команду. Дождитесь статуса *"Running"*.

После того, как ваши контейнеры развернулись и заработали, сделаем доступ из интернета к ним, выполнив команду:
```
kubectl apply -f load-balancer.yaml
```
Необходимо подождать секунд 10, затем можно получить внешний IP-адрес, с помощью команды:
```
kubectl describe service
```

В выведеном сообщении найдите строку "LoadBalancer Ingress:     xxx.xxx.xxx.xxx", где xxx.xxx.xxx.xxx - это внешний ip-адрес.

Откройте Браузер интернета и в адресной строке вставьте этот адрес, нажмите ввод.
У вас должен открытся сайт проекта Taski.
<p align="center"><img src="./images/taski-site.png" alt="Сайт проекта Taski."></p>

Проверьте, что задания можно создавать.
<p align="center"><img src="./images/taski-proved.png" alt="Проверка создания задания."></p>

На этом развёртывание проекта Taski в облачном кластере Yandex.Cloud завершено.

### Заключение.
Вы развернули в облаке Yandex.Cloud проект Taski с помощью Kubernetes.
Размеры образов получились следующими:
<p align="center"><img src="./images/images-sizes.png" alt="Размеры образов docker-контейнеров."></p>

### Дополнительная информация.
Не забудьте удалить с локального компьютера неиспользуемые части проекта Taski.
Это можно сделать последовательно выполнив следующие две команды:
```
docker system prune
docker rmi -f $(docker images -qa)
```

#### Не забудьте в облаке Yandex.Cloud удалить кластер и загруженные в "Container Registry" образы docker-контейнеров, а также сам реестр!

# Спасибо за внимание. =)
